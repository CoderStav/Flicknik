__version__ = "0.1"import kivyfrom kivy.app import Appfrom kivy.lang import Builderfrom kivy.logger import Loggerfrom kivy.core.window import Windowfrom kivy.uix.screenmanager import ScreenManager, Screen, RiseInTransition, FallOutTransitionfrom screen_home import homeScreenfrom screen_submit import submitScreenfrom screen_fullview import fullviewScreen, photoScreenfrom screen_reply import replyScreenfrom plyer.platforms.android.uniqueid import AndroidUniqueIDfrom plyer import gpsimport hashlibfrom threading import ThreadBuilder.load_string("""<ImgBtn@Button>:    source: None    Image:        source: root.source        pos: root.pos        size: root.size        <homeScreen>:    canvas.before:        Color:            rgb: 1, 1, 1, 1        Rectangle:            pos: self.pos            size: self.size    ScrollView:        id: homescr_scrollv        size_hint: (1, 1)        pos_hint: {'center_x':.5, 'center_y':.35}        GridLayout:            id: homescr_output            cols: 1            size_hint_y: None            height: self.minimum_height            row_default_height: "125dp"                FloatLayout:        id: homescr_topbar        pos_hint: {'top':1}        size_hint: (1, 0.1)        canvas.before:            Color:                rgb: 0.14901960784, 0.57647058823, 1, 1            Rectangle:                pos: self.pos                size: self.size        Image:            source: 'data/flicknik_text.png'            size_hint: (0.3, 1)            pos_hint: {'center_x':0.5, 'y':0}                ImgBtn:            id: homescr_nextButton            source: 'data/blank.png'            background_normal: ''            background_color: [0.11764705882352941, 0.4588235294117647, 0.8, 0]            pos_hint: {'right':0.9825, 'center_y':0.5}             size_hint: (0.10,0.50)            on_press: root.changePage(1)                    ImgBtn:            id: homescr_backButton            source: 'data/blank.png'            background_normal: ''            background_color: [0.11764705882352941, 0.4588235294117647, 0.8, 0]            pos_hint: {'x':0.0175, 'center_y':0.5}             size_hint: (0.10,0.50)            on_press: root.changePage(-1)        BoxLayout:        orientation: 'horizontal'        pos_hint: {'top':0.9}        size_hint: (1, 0.05)        Button:            id: homescr_hotsort            text: 'Hot'            background_normal: ''            background_color: [0.14901960784, 0.57647058823, 1, 0.5]            on_press: root.display(0, False)            on_press: root.buttonHighlight(0)        Button:            id: homescr_newsort            text: 'New'            background_normal: ''            background_color: [0.14901960784, 0.57647058823, 1, 0.5]            on_press: root.display(1, False)            on_press: root.buttonHighlight(1)        Button:            id: homescr_topsort            text: 'Best'            background_normal: ''            background_color: [0.14901960784, 0.57647058823, 1, 0.5]            on_press: root.display(2, False)            on_press: root.buttonHighlight(2)        Button:            id: homescr_badsort            text: 'Worst'            background_normal: ''            background_color: [0.14901960784, 0.57647058823, 1, 0.5]            on_press: root.display(3, False)            on_press: root.buttonHighlight(3)            FloatLayout:        id: homescr_bottombar        pos_hint: {'y':0}        size_hint: (1, 0.1)        canvas.before:            Color:                rgb: 0.14901960784, 0.57647058823, 1, 1            Rectangle:                pos: self.pos                size: self.size        ImgBtn:            id: homescr_renderbutton            source: 'data/refresh.png'            background_normal: ''            background_color: [0.11764705882352941, 0.4588235294117647, 0.8, 0]            size_hint: (0.2, 1)            pos_hint: {'left':1, 'y':0}            on_press: root.display()                ImgBtn:            id: homescr_submitbutton            source: 'data/flick.png'            background_normal: ''            background_color: [0.11764705882352941, 0.4588235294117647, 0.8, 0]            size_hint: (0.2, 1)            pos_hint: {'right':1, 'center_y':0.5}            on_press: app.changeScreen("submit")                FloatLayout:        id: homescr_overlay        pos_hint: {'center_x':.5, 'center_y':.5}        size_hint: (1, 1)                Label:            id: homescr_statusmsg            pos_hint: {'center_x':.5, 'center_y':.5}            font_size: '15sp'            color: [0.11764705882352941, 0.4588235294117647, 0.8, 0.5]            <submitScreen>:    canvas.before:        Color:            rgb: 1, 1, 1, 1        Rectangle:            pos: self.pos            size: self.size                    BoxLayout:        orientation: "vertical"        BoxLayout:            orientation: "vertical"            size_hint_y: 0.5            BoxLayout:                orientation: "horizontal"                size_hint_y: 0.2                Button:                    id: upload_camera_button                    font_size: "15sp"                    text: "Take a photo"                    background_normal: ''                    background_color: [0.14901960784, 0.57647058823, 1, 1]                    on_press: root.loadCamera()                Button:                    id: upload_video_button                    font_size: "15sp"                    text: "Take a video"                    background_normal: ''                    background_color: [0.14901960784, 0.57647058823, 1, 1]                    on_press: root.loadVideoCamera()            TextInput:                size_hint_y: 0.3                id: upload_title                font_size: "15sp"                hint_text: "Title"            TextInput:                size_hint_y: 0.3                id: upload_caption                font_size: "15sp"                hint_text: "Caption"            Button:                size_hint_y: 0.2                id: upload_button                font_size: "15sp"                text: "Submit"                background_normal: ''                background_color: [0.14901960784, 0.57647058823, 1, 1]                on_press: root.uploadInitialize()        BoxLayout:            orientation: "vertical"            size_hint_y: 0.5<replyScreen>:    canvas.before:        Color:            rgb: 1, 1, 1, 1        Rectangle:            pos: self.pos            size: self.size                ScrollView:        id: replyscr_scrollv        size_hint: (1, 1)        pos_hint: {'center_x':.5, 'center_y':.4}        GridLayout:            id: replyscr_output            cols: 1            size_hint_y: None            height: self.minimum_height            row_default_height: "125dp"                FloatLayout:        id: replyscr_bottombar        pos_hint: {'y':0}        size_hint: (1, 0.1)        canvas.before:            Color:                rgb: 0.14901960784, 0.57647058823, 1, 1            Rectangle:                pos: self.pos                size: self.size        TextInput:            id: replyscr_replyfield            hint_text: 'Write a reply'            font_size: "15sp"            size_hint: (0.8, 0.8)            pos_hint: {'x':0.01, 'center_y':0.5}        ImgBtn:            id: replyscr_replybutton            source: 'data/comment.png'            on_press: root.submitReply()            background_normal: ''            background_color: [0.11764705882352941, 0.4588235294117647, 0.8, 0]            size_hint: (0.15, 1)            pos_hint: {'right':0.98, 'center_y':0.5}    FloatLayout:        pos_hint: {'top':1}        size_hint: (1, 0.1)        canvas.before:            Color:                rgb: 0.14901960784, 0.57647058823, 1, 1            Rectangle:                pos: self.pos                size: self.size        Image:            source: 'data/flicknik_text.png'            size_hint: (0.3, 1)            pos_hint: {'center_x':0.5, 'y':0}                FloatLayout:        id: replyscr_overlay        pos_hint: {'center_x':.5, 'center_y':.5}        size_hint: (1, 1)                Label:            id: replyscr_statusmsg            pos_hint: {'center_x':.5, 'center_y':.5}            font_size: '15sp'            color: [0.11764705882352941, 0.4588235294117647, 0.8, 0.5]<photoScreen>:    canvas.before:        Color:            rgb: 1, 1, 1, 1        Rectangle:            pos: self.pos            size: self.size    BoxLayout:        id: fullimg_holder        size_hint: (1,1)""")class flicknik(App):    """Base flicknik app class"""    def build(self):        self.screens = []                # url for backend server        self.backend = "http://orange-missile-62-184276.usw1.nitrousbox.com/"                # unique user id variables        self.usr = AndroidUniqueID()        self.usrid = hashlib.md5(self.usr._get_uid()).hexdigest()                self.lat = None        self.lon = None        self.locationIdentified = False                self.manager = ScreenManager(transition=RiseInTransition())        self.manager.add_widget(homeScreen(name='home'))        self.manager.add_widget(submitScreen(name='submit'))        self.manager.add_widget(replyScreen(name='reply'))                return self.manager        def setCoordinatesRefresh(self, **kwargs):        """Sets coordinate values lat and lon (for retrieving posts)"""                gps.stop()        Logger.info("GPS: lat: {lat} long: {lon}".format(**kwargs))        self.lat = float("{lat}".format(**kwargs));        self.lon = float("{lon}".format(**kwargs));        self.locationIdentified = True        self.manager.get_screen("home").getPosts()        def setCoordinatesPost(self, **kwargs):        """Sets coordinate values lat and lon (for submitting posts)"""                Logger.info("GPS: lat: {lat} long: {lon}".format(**kwargs))        self.lat = float("{lat}".format(**kwargs));        self.lon = float("{lon}".format(**kwargs));        self.locationIdentified = True        gps.stop()        Thread(target=self.manager.get_screen("submit").uploadToServer).start()            def getCoordinates(self, isPost=False):        """Gets coordinatates from plyer gps module. Configures gps with different callbacks depending on the situation"""                if isPost == False:            gps.configure(on_location=self.setCoordinatesRefresh)        elif isPost == True:            gps.configure(on_location=self.setCoordinatesPost)                Logger.info("GPS: GPS Starting...")        gps.start()            def changeScreen(self, scrn):        """Changes the current screen"""                self.screens.append(self.manager.current)        self.manager.current = scrn        def android_back_btn(self, window, key, *largs):        """Goes to the previous screen when android back button is pressed"""                if key == 27:            if len(self.screens) > 0:                Logger.info("flicknik: Returning to {}".format(self.screens[-1]))                self.manager.transition = FallOutTransition()                self.manager.current = self.screens.pop()                self.manager.transition = RiseInTransition()                return True        return False        def on_start(self):        from kivy.base import EventLoop        EventLoop.window.bind(on_keyboard=self.android_back_btn)        def on_pause(self):        return True    def on_resume(self):        passif __name__ in ('__main__','__android__'):                                   flicknik().run()